<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date Planner - Expressing Love</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./css/auth.css">
    <style>
        .date-planner-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .back-home {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary-color, #ff6b9d);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
        }

        .back-home:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 107, 157, 0.4);
        }

        .date-planner-header {
            text-align: center;
            margin: 80px 0 30px 0;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .planner-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .planner-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .date-ideas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .date-idea-card {
            background: linear-gradient(135deg, #ffeef8, #fff5f8);
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .date-idea-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color, #ff6b9d);
            box-shadow: 0 10px 25px rgba(255, 107, 157, 0.2);
        }

        .date-idea-card.selected {
            border-color: var(--primary-color, #ff6b9d);
            background: linear-gradient(135deg, #ff6b9d, #ff9a9e);
            color: white;
        }

        .idea-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .idea-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .idea-description {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color, #ff6b9d);
            box-shadow: 0 0 10px rgba(255, 107, 157, 0.2);
        }

        .create-date-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .create-date-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .planned-dates-section {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .date-card {
            background: linear-gradient(135deg, #ffeef8, #fff5f8);
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .date-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .date-card.completed {
            background: linear-gradient(135deg, #c8e6c9, #e8f5e8);
            border-color: #4caf50;
        }

        .date-card.upcoming {
            background: linear-gradient(135deg, #fff3e0, #ffeaa7);
            border-color: #ff9800;
        }

        .date-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .date-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .date-type {
            display: inline-block;
            background: var(--primary-color, #ff6b9d);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .date-details {
            margin-bottom: 15px;
        }

        .date-detail {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            color: #555;
        }

        .date-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .complete-btn {
            background: #4caf50;
            color: white;
        }

        .edit-btn {
            background: #2196f3;
            color: white;
        }

        .delete-btn {
            background: #f44336;
            color: white;
        }

        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .budget-tracker {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .budget-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            text-align: center;
        }

        .budget-stat {
            padding: 15px;
            background: linear-gradient(135deg, #ffeef8, #fff5f8);
            border-radius: 10px;
        }

        .budget-number {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-color, #ff6b9d);
        }

        .budget-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .date-planner-container {
                padding: 15px;
            }
            
            .back-home {
                position: relative;
                display: block;
                text-align: center;
                margin-bottom: 20px;
            }

            .planner-sections {
                grid-template-columns: 1fr;
            }

            .date-ideas-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .date-header {
                flex-direction: column;
                gap: 10px;
            }

            .date-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Background Music -->
    <audio id="backgroundMusic" autoplay loop preload="auto" style="display: none;">
        <source src="https://files.catbox.moe/4vb6xe.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Animated floating hearts background -->
    <div class="hearts-container" id="hearts-container"></div>

    <a href="index.html" class="back-home">üè† Back to Home</a>

    <div class="date-planner-container">
        <div class="date-planner-header">
            <h1>üìç Date Planner</h1>
            <p>Plan perfect romantic dates and create lasting memories together</p>
        </div>

        <div class="planner-sections">
            <div class="planner-section">
                <h3>üí° Date Ideas</h3>
                <div class="date-ideas-grid" id="date-ideas-grid">
                    <div class="date-idea-card" onclick="selectDateIdea('romantic-dinner', 'üçΩÔ∏è Romantic Dinner', 'Candlelit dinner at home or restaurant')">
                        <div class="idea-icon">üçΩÔ∏è</div>
                        <div class="idea-title">Romantic Dinner</div>
                        <div class="idea-description">Candlelit dinner</div>
                    </div>
                    
                    <div class="date-idea-card" onclick="selectDateIdea('movie-night', 'üé¨ Movie Night', 'Cozy movie night with popcorn and cuddles')">
                        <div class="idea-icon">üé¨</div>
                        <div class="idea-title">Movie Night</div>
                        <div class="idea-description">Cozy night in</div>
                    </div>
                    
                    <div class="date-idea-card" onclick="selectDateIdea('outdoor-adventure', 'üèûÔ∏è Outdoor Adventure', 'Hiking, picnic, or nature exploration')">
                        <div class="idea-icon">üèûÔ∏è</div>
                        <div class="idea-title">Outdoor Adventure</div>
                        <div class="idea-description">Nature exploration</div>
                    </div>
                    
                    <div class="date-idea-card" onclick="selectDateIdea('cultural-visit', 'üé≠ Cultural Visit', 'Museum, gallery, or theater experience')">
                        <div class="idea-icon">üé≠</div>
                        <div class="idea-title">Cultural Visit</div>
                        <div class="idea-description">Arts & culture</div>
                    </div>
                    
                    <div class="date-idea-card" onclick="selectDateIdea('sports-activity', '‚öΩ Sports Activity', 'Mini golf, bowling, or sports together')">
                        <div class="idea-icon">‚öΩ</div>
                        <div class="idea-title">Sports Activity</div>
                        <div class="idea-description">Active fun</div>
                    </div>
                    
                    <div class="date-idea-card" onclick="selectDateIdea('creative-date', 'üé® Creative Date', 'Art class, cooking, or DIY project')">
                        <div class="idea-icon">üé®</div>
                        <div class="idea-title">Creative Date</div>
                        <div class="idea-description">Make something together</div>
                    </div>
                </div>
            </div>

            <div class="planner-section">
                <h3>üìÖ Plan Your Date</h3>
                <form id="create-date-form">
                    <div class="form-group">
                        <label for="date-title">üíï Date Title</label>
                        <input type="text" id="date-title" class="form-input" 
                               placeholder="e.g., Romantic Dinner at La Bella" required>
                    </div>

                    <div class="form-group">
                        <label for="date-type">üéØ Date Type</label>
                        <select id="date-type" class="form-input" required>
                            <option value="">Select date type...</option>
                            <option value="romantic-dinner">üçΩÔ∏è Romantic Dinner</option>
                            <option value="movie-night">üé¨ Movie Night</option>
                            <option value="outdoor-adventure">üèûÔ∏è Outdoor Adventure</option>
                            <option value="cultural-visit">üé≠ Cultural Visit</option>
                            <option value="sports-activity">‚öΩ Sports Activity</option>
                            <option value="creative-date">üé® Creative Date</option>
                            <option value="custom">üåü Custom</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="date-datetime">üìÖ Date & Time</label>
                        <input type="datetime-local" id="date-datetime" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label for="date-location">üìç Location</label>
                        <input type="text" id="date-location" class="form-input" 
                               placeholder="e.g., Central Park, Home, La Bella Restaurant" required>
                    </div>

                    <div class="form-group">
                        <label for="date-budget">üí∞ Estimated Budget</label>
                        <input type="number" id="date-budget" class="form-input" 
                               placeholder="0" min="0" step="0.01">
                    </div>

                    <div class="form-group">
                        <label for="date-notes">üìù Special Notes</label>
                        <textarea id="date-notes" class="form-input" rows="3" 
                                 placeholder="Special requests, outfit ideas, or other notes..."></textarea>
                    </div>

                    <button type="submit" class="create-date-btn">
                        ‚ú® Plan This Date
                    </button>
                </form>
            </div>
        </div>

        <div class="budget-tracker">
            <h3>üí∞ Budget Tracker</h3>
            <div class="budget-stats">
                <div class="budget-stat">
                    <div class="budget-number" id="total-budget">$0</div>
                    <div class="budget-label">Total Planned</div>
                </div>
                <div class="budget-stat">
                    <div class="budget-number" id="spent-budget">$0</div>
                    <div class="budget-label">Already Spent</div>
                </div>
                <div class="budget-stat">
                    <div class="budget-number" id="upcoming-budget">$0</div>
                    <div class="budget-label">Upcoming Dates</div>
                </div>
                <div class="budget-stat">
                    <div class="budget-number" id="average-cost">$0</div>
                    <div class="budget-label">Average Cost</div>
                </div>
            </div>
        </div>

        <div class="planned-dates-section">
            <h3>üìÖ Your Planned Dates</h3>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;">
                <button class="filter-tab active" onclick="filterDates('all')">üåü All Dates</button>
                <button class="filter-tab" onclick="filterDates('upcoming')">‚è∞ Upcoming</button>
                <button class="filter-tab" onclick="filterDates('completed')">‚úÖ Completed</button>
                <button class="filter-tab" onclick="filterDates('past')">üìÖ Past</button>
            </div>

            <div class="dates-list" id="dates-list">
                <div style="text-align: center; padding: 40px; color: #666;">
                    <h4>üìç Loading your planned dates...</h4>
                    <p>Getting your romantic schedule</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import './js/auth-guard.js';
        import authManager from './js/auth.js';
        import { db, collection, getDocs, addDoc, doc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot } from './js/firebase-config.js';

        let currentUser = null;
        let selectedDateIdea = null;
        let allDates = [];
        let currentFilter = 'all';

        // Create floating hearts animation
        function createFloatingHearts() {
            const heartsContainer = document.getElementById('hearts-container');
            const hearts = ['üíñ', 'üíï', 'üíó', 'üíò', 'üíù', 'üíú', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô'];
            
            setInterval(() => {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.innerHTML = hearts[Math.floor(Math.random() * hearts.length)];
                heart.style.left = Math.random() * 100 + 'vw';
                heart.style.animationDuration = (Math.random() * 3 + 3) + 's';
                heart.style.opacity = Math.random() * 0.5 + 0.3;
                
                heartsContainer.appendChild(heart);
                
                setTimeout(() => {
                    if (heart.parentNode) {
                        heart.parentNode.removeChild(heart);
                    }
                }, 10000);
            }, 500);
        }

        window.selectDateIdea = function(ideaId, title, description) {
            selectedDateIdea = { id: ideaId, title, description };
            
            // Update form with selected idea
            document.getElementById('date-title').value = title;
            document.getElementById('date-type').value = ideaId;
            
            // Update UI
            document.querySelectorAll('.date-idea-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.date-idea-card').classList.add('selected');
        }

        async function createPlannedDate(event) {
            event.preventDefault();
            
            const title = document.getElementById('date-title').value.trim();
            const type = document.getElementById('date-type').value;
            const datetime = document.getElementById('date-datetime').value;
            const location = document.getElementById('date-location').value.trim();
            const budget = parseFloat(document.getElementById('date-budget').value) || 0;
            const notes = document.getElementById('date-notes').value.trim();

            if (!title || !type || !datetime || !location) {
                alert('Please fill in all required fields');
                return;
            }

            const dateTime = new Date(datetime);
            if (dateTime < new Date()) {
                if (!confirm('This date is in the past. Do you want to create it anyway?')) {
                    return;
                }
            }

            try {
                await addDoc(collection(db, 'plannedDates'), {
                    title: title,
                    type: type,
                    datetime: datetime,
                    location: location,
                    budget: budget,
                    notes: notes,
                    completed: false,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'Anonymous',
                    createdAt: new Date().toISOString(),
                    completedAt: null
                });

                // Reset form
                document.getElementById('create-date-form').reset();
                document.querySelectorAll('.date-idea-card').forEach(card => card.classList.remove('selected'));
                selectedDateIdea = null;

                alert('Date planned successfully! üìÖ');
            } catch (error) {
                console.error('Error creating planned date:', error);
                alert('Failed to plan date. Please try again.');
            }
        }

        async function loadPlannedDates() {
            const datesQuery = query(
                collection(db, 'plannedDates'),
                where('userId', '==', currentUser.uid),
                orderBy('datetime', 'asc')
            );

            onSnapshot(datesQuery, (snapshot) => {
                allDates = [];
                snapshot.forEach(doc => {
                    allDates.push({ id: doc.id, ...doc.data() });
                });
                displayDates();
                updateBudgetStats();
            });
        }

        function displayDates() {
            const container = document.getElementById('dates-list');
            let datesToShow = allDates;
            const now = new Date();

            // Apply filters
            if (currentFilter !== 'all') {
                if (currentFilter === 'upcoming') {
                    datesToShow = allDates.filter(date => new Date(date.datetime) > now && !date.completed);
                } else if (currentFilter === 'completed') {
                    datesToShow = allDates.filter(date => date.completed);
                } else if (currentFilter === 'past') {
                    datesToShow = allDates.filter(date => new Date(date.datetime) < now && !date.completed);
                }
            }
            
            if (datesToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h4>üìç No dates found</h4>
                        <p>Start planning your romantic adventures!</p>
                    </div>
                `;
                return;
            }

            const typeEmojis = {
                'romantic-dinner': 'üçΩÔ∏è',
                'movie-night': 'üé¨',
                'outdoor-adventure': 'üèûÔ∏è',
                'cultural-visit': 'üé≠',
                'sports-activity': '‚öΩ',
                'creative-date': 'üé®',
                'custom': 'üåü'
            };

            container.innerHTML = datesToShow.map(date => {
                const dateTime = new Date(date.datetime);
                const isUpcoming = dateTime > now && !date.completed;
                const isPast = dateTime < now && !date.completed;
                const dateString = dateTime.toLocaleDateString();
                const timeString = dateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                let cardClass = 'date-card';
                if (date.completed) cardClass += ' completed';
                else if (isUpcoming) cardClass += ' upcoming';
                
                return `
                    <div class="${cardClass}">
                        <div class="date-header">
                            <div>
                                <div class="date-title">${typeEmojis[date.type] || 'üìç'} ${date.title}</div>
                                <div class="date-type">${date.type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                            </div>
                            <div class="date-actions">
                                ${!date.completed && !isPast ? `<button class="action-btn complete-btn" onclick="completeDate('${date.id}')">‚úÖ Mark Complete</button>` : ''}
                                <button class="action-btn delete-btn" onclick="deleteDate('${date.id}')">üóëÔ∏è</button>
                            </div>
                        </div>

                        <div class="date-details">
                            <div class="date-detail">
                                <span>üìÖ</span>
                                <span>${dateString} at ${timeString}</span>
                            </div>
                            <div class="date-detail">
                                <span>üìç</span>
                                <span>${date.location}</span>
                            </div>
                            ${date.budget > 0 ? `
                                <div class="date-detail">
                                    <span>üí∞</span>
                                    <span>Budget: $${date.budget.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            ${date.notes ? `
                                <div class="date-detail">
                                    <span>üìù</span>
                                    <span>${date.notes}</span>
                                </div>
                            ` : ''}
                            ${date.completed && date.completedAt ? `
                                <div class="date-detail">
                                    <span>‚úÖ</span>
                                    <span>Completed on ${new Date(date.completedAt).toLocaleDateString()}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.filterDates = function(filter) {
            currentFilter = filter;
            
            // Update UI
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            displayDates();
        }

        window.completeDate = async function(dateId) {
            if (!confirm('Mark this date as completed? üéâ')) return;

            try {
                const dateRef = doc(db, 'plannedDates', dateId);
                await updateDoc(dateRef, {
                    completed: true,
                    completedAt: new Date().toISOString()
                });

                // Trigger confetti for completion
                if (window.triggerConfetti) {
                    window.triggerConfetti();
                }
                
                alert('Date completed! üéâ Hope you had a wonderful time!');
            } catch (error) {
                console.error('Error completing date:', error);
                alert('Failed to mark date as completed. Please try again.');
            }
        }

        window.deleteDate = async function(dateId) {
            if (!confirm('Are you sure you want to delete this planned date?')) return;

            try {
                await deleteDoc(doc(db, 'plannedDates', dateId));
                alert('Date deleted successfully');
            } catch (error) {
                console.error('Error deleting date:', error);
                alert('Failed to delete date. Please try again.');
            }
        }

        function updateBudgetStats() {
            const totalBudget = allDates.reduce((sum, date) => sum + (date.budget || 0), 0);
            const spentBudget = allDates.filter(date => date.completed).reduce((sum, date) => sum + (date.budget || 0), 0);
            const upcomingBudget = allDates.filter(date => !date.completed && new Date(date.datetime) > new Date()).reduce((sum, date) => sum + (date.budget || 0), 0);
            const averageCost = allDates.length > 0 ? totalBudget / allDates.length : 0;

            document.getElementById('total-budget').textContent = '$' + totalBudget.toFixed(2);
            document.getElementById('spent-budget').textContent = '$' + spentBudget.toFixed(2);
            document.getElementById('upcoming-budget').textContent = '$' + upcomingBudget.toFixed(2);
            document.getElementById('average-cost').textContent = '$' + averageCost.toFixed(2);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createFloatingHearts();
            
            // Set minimum datetime to now
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('date-datetime').min = now.toISOString().slice(0, 16);
            
            setTimeout(() => {
                currentUser = authManager.currentUser;
                if (currentUser) {
                    loadPlannedDates();
                }
            }, 1000);

            // Setup form submission
            document.getElementById('create-date-form').addEventListener('submit', createPlannedDate);

            // Add filter tab styles
            const style = document.createElement('style');
            style.textContent = `
                .filter-tab {
                    padding: 10px 20px;
                    border: 2px solid #e0e0e0;
                    background: white;
                    border-radius: 20px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    font-weight: 500;
                    font-size: 0.9em;
                }
                .filter-tab:hover {
                    border-color: var(--primary-color, #ff6b9d);
                    background: rgba(255, 107, 157, 0.1);
                }
                .filter-tab.active {
                    border-color: var(--primary-color, #ff6b9d);
                    background: var(--primary-color, #ff6b9d);
                    color: white;
                }
            `;
            document.head.appendChild(style);
        });

        // Background music handler
        document.addEventListener('DOMContentLoaded', function() {
            const music = document.getElementById('backgroundMusic');
            
            function playMusic() {
                if (music) {
                    music.volume = 0.3;
                    music.play().then(() => {
                        console.log('Background music started playing');
                    }).catch(error => {
                        console.log('Could not autoplay audio:', error);
                        document.addEventListener('click', function playOnClick() {
                            music.play().then(() => {
                                console.log('Background music started after user click');
                                document.removeEventListener('click', playOnClick);
                            }).catch(err => console.log('Still could not play audio:', err));
                        }, { once: true });
                    });
                }
            }
            
            playMusic();
        });

        // Load confetti script if available
        const confettiScript = document.createElement('script');
        confettiScript.src = './js/confetti.js';
        confettiScript.type = 'module';
        document.head.appendChild(confettiScript);
    </script>
</body>
</html>