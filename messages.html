<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Expressing Love</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./css/auth.css">
    <style>
        .messages-container {
            display: flex;
            height: calc(100vh - 80px);
            margin-top: 80px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .back-home {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary-color, #ff6b9d);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
        }

        .back-home:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 107, 157, 0.4);
        }

        .conversations-list {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px 0 0 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .conversations-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 0 0 0;
        }

        .conversation-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .conversation-item:hover {
            background: rgba(255, 107, 157, 0.1);
        }

        .conversation-item.active {
            background: rgba(255, 107, 157, 0.2);
            border-left: 4px solid var(--primary-color, #ff6b9d);
        }

        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--primary-color, #ff6b9d);
            object-fit: cover;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-preview {
            font-size: 0.9em;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background: var(--primary-color, #ff6b9d);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0 20px 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 0 20px 0 0;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid white;
            object-fit: cover;
        }

        .chat-info h3 {
            margin: 0;
            font-size: 1.2em;
        }

        .chat-info p {
            margin: 5px 0 0 0;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(to bottom, #ffeef8, #fff5f8);
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .message.sent {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ddd;
            object-fit: cover;
        }

        .message-content {
            max-width: 70%;
            background: white;
            padding: 12px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .message.sent .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message-time {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        .message.sent .message-time {
            color: rgba(255, 255, 255, 0.7);
        }

        .message-input-area {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary-color, #ff6b9d);
            box-shadow: 0 0 10px rgba(255, 107, 157, 0.2);
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #666;
        }

        .empty-conversations {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #666;
        }

        @media (max-width: 768px) {
            .messages-container {
                flex-direction: column;
                height: auto;
                margin-top: 60px;
            }

            .back-home {
                position: relative;
                display: block;
                text-align: center;
                margin-bottom: 20px;
            }

            .conversations-list {
                width: 100%;
                border-radius: 20px 20px 0 0;
                max-height: 200px;
            }

            .chat-area {
                border-radius: 0 0 20px 20px;
                height: 500px;
            }

            .conversations-header, .chat-header {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Background Music -->
    <audio id="backgroundMusic" autoplay loop preload="auto" style="display: none;">
        <source src="https://files.catbox.moe/4vb6xe.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Animated floating hearts background -->
    <div class="hearts-container" id="hearts-container"></div>

    <a href="index.html" class="back-home">üè† Back to Home</a>

    <div class="messages-container">
        <div class="conversations-list">
            <div class="conversations-header">
                <h3>üí¨ Messages</h3>
            </div>
            <div id="conversations-content">
                <div class="empty-conversations">
                    <h4>üì≠ No messages yet</h4>
                    <p>Start conversations with other users!</p>
                    <a href="users.html" style="color: var(--primary-color); text-decoration: none; font-weight: 600;">
                        üë• Discover Users
                    </a>
                </div>
            </div>
        </div>

        <div class="chat-area">
            <div id="chat-content" class="empty-chat">
                <h2>üíå Select a conversation</h2>
                <p>Choose a conversation from the left to start messaging</p>
            </div>
        </div>
    </div>

    <script type="module">
        import './js/auth-guard.js';
        import authManager from './js/auth.js';
        import { db, collection, getDocs, addDoc, doc, getDoc, query, where, orderBy, onSnapshot, updateDoc } from './js/firebase-config.js';

        let currentUser = null;
        let currentConversation = null;
        let conversations = [];
        let messages = [];
        let unsubscribeMessages = null;

        // Create floating hearts animation
        function createFloatingHearts() {
            const heartsContainer = document.getElementById('hearts-container');
            const hearts = ['üíñ', 'üíï', 'üíó', 'üíò', 'üíù', 'üíú', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô'];
            
            setInterval(() => {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.innerHTML = hearts[Math.floor(Math.random() * hearts.length)];
                heart.style.left = Math.random() * 100 + 'vw';
                heart.style.animationDuration = (Math.random() * 3 + 3) + 's';
                heart.style.opacity = Math.random() * 0.5 + 0.3;
                
                heartsContainer.appendChild(heart);
                
                setTimeout(() => {
                    if (heart.parentNode) {
                        heart.parentNode.removeChild(heart);
                    }
                }, 10000);
            }, 500);
        }

        async function loadConversations() {
            try {
                currentUser = authManager.currentUser;
                if (!currentUser) {
                    window.location.href = 'login.html';
                    return;
                }

                // Get all messages where current user is sender or receiver
                const messagesQuery = query(
                    collection(db, 'messages'),
                    orderBy('timestamp', 'desc')
                );

                onSnapshot(messagesQuery, (snapshot) => {
                    const allMessages = [];
                    snapshot.forEach(doc => {
                        const message = { id: doc.id, ...doc.data() };
                        if (message.from === currentUser.uid || message.to === currentUser.uid) {
                            allMessages.push(message);
                        }
                    });

                    // Group messages by conversation partner
                    const conversationMap = new Map();
                    
                    allMessages.forEach(message => {
                        const partnerId = message.from === currentUser.uid ? message.to : message.from;
                        const partnerName = message.from === currentUser.uid ? message.toName : message.fromName;
                        const partnerPhoto = message.from === currentUser.uid ? '' : message.fromPhoto;
                        
                        if (!conversationMap.has(partnerId)) {
                            conversationMap.set(partnerId, {
                                id: partnerId,
                                name: partnerName,
                                photo: partnerPhoto,
                                lastMessage: message,
                                unreadCount: 0
                            });
                        }

                        const conversation = conversationMap.get(partnerId);
                        if (new Date(message.timestamp) > new Date(conversation.lastMessage.timestamp)) {
                            conversation.lastMessage = message;
                        }

                        // Count unread messages (messages sent to current user that are unread)
                        if (message.to === currentUser.uid && !message.read) {
                            conversation.unreadCount++;
                        }
                    });

                    conversations = Array.from(conversationMap.values());
                    displayConversations();
                });

            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        function displayConversations() {
            const content = document.getElementById('conversations-content');
            
            if (conversations.length === 0) {
                content.innerHTML = `
                    <div class="empty-conversations">
                        <h4>üì≠ No messages yet</h4>
                        <p>Start conversations with other users!</p>
                        <a href="users.html" style="color: var(--primary-color); text-decoration: none; font-weight: 600;">
                            üë• Discover Users
                        </a>
                    </div>
                `;
                return;
            }

            content.innerHTML = conversations.map(conv => `
                <div class="conversation-item ${currentConversation?.id === conv.id ? 'active' : ''}" 
                     onclick="selectConversation('${conv.id}', '${conv.name}', '${conv.photo}')">
                    <img src="${conv.photo || 'https://via.placeholder.com/50x50/ff6b9d/white?text=' + (conv.name ? conv.name.charAt(0) : '?')}" 
                         alt="${conv.name}" 
                         class="conversation-avatar">
                    <div class="conversation-info">
                        <div class="conversation-name">${conv.name || 'Anonymous'}</div>
                        <div class="conversation-preview">
                            ${conv.lastMessage.from === currentUser.uid ? 'You: ' : ''}${conv.lastMessage.content}
                        </div>
                    </div>
                    ${conv.unreadCount > 0 ? `<div class="unread-badge">${conv.unreadCount}</div>` : ''}
                </div>
            `).join('');
        }

        window.selectConversation = async function(partnerId, partnerName, partnerPhoto) {
            currentConversation = { id: partnerId, name: partnerName, photo: partnerPhoto };
            
            // Update active conversation in UI
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.conversation-item').classList.add('active');

            // Mark messages as read
            const messagesQuery = query(
                collection(db, 'messages'),
                where('from', '==', partnerId),
                where('to', '==', currentUser.uid),
                where('read', '==', false)
            );

            try {
                const snapshot = await getDocs(messagesQuery);
                const batch = [];
                snapshot.forEach(doc => {
                    batch.push(updateDoc(doc.ref, { read: true }));
                });
                await Promise.all(batch);
            } catch (error) {
                console.error('Error marking messages as read:', error);
            }

            // Load messages for this conversation
            loadMessages();
            setupChatArea();
        }

        function setupChatArea() {
            const chatContent = document.getElementById('chat-content');
            chatContent.innerHTML = `
                <div class="chat-header">
                    <img src="${currentConversation.photo || 'https://via.placeholder.com/50x50/ff6b9d/white?text=' + (currentConversation.name ? currentConversation.name.charAt(0) : '?')}" 
                         alt="${currentConversation.name}" 
                         class="chat-avatar">
                    <div class="chat-info">
                        <h3>${currentConversation.name || 'Anonymous'}</h3>
                        <p>Send a message to continue the conversation</p>
                    </div>
                </div>
                <div class="messages-area" id="messages-area">
                    <!-- Messages will be loaded here -->
                </div>
                <div class="message-input-area">
                    <textarea class="message-input" id="message-input" 
                             placeholder="Type your message..." 
                             onkeypress="handleKeyPress(event)"></textarea>
                    <button class="send-btn" onclick="sendMessage()">üíå</button>
                </div>
            `;
        }

        function loadMessages() {
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }

            const messagesQuery = query(
                collection(db, 'messages'),
                orderBy('timestamp', 'asc')
            );

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                messages = [];
                snapshot.forEach(doc => {
                    const message = { id: doc.id, ...doc.data() };
                    // Only show messages between current user and selected partner
                    if ((message.from === currentUser.uid && message.to === currentConversation.id) ||
                        (message.from === currentConversation.id && message.to === currentUser.uid)) {
                        messages.push(message);
                    }
                });
                displayMessages();
            });
        }

        function displayMessages() {
            const messagesArea = document.getElementById('messages-area');
            if (!messagesArea) return;

            if (messages.length === 0) {
                messagesArea.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h4>üíå Start your conversation</h4>
                        <p>Be the first to send a message!</p>
                    </div>
                `;
                return;
            }

            messagesArea.innerHTML = messages.map(message => {
                const isSent = message.from === currentUser.uid;
                const messageTime = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const senderPhoto = isSent ? (currentUser.photoURL || '') : currentConversation.photo;
                
                return `
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        <img src="${senderPhoto || 'https://via.placeholder.com/30x30/ff6b9d/white?text=' + (isSent ? (currentUser.displayName ? currentUser.displayName.charAt(0) : '?') : (currentConversation.name ? currentConversation.name.charAt(0) : '?'))}" 
                             alt="Avatar" 
                             class="message-avatar">
                        <div class="message-content">
                            <div>${message.content}</div>
                            <div class="message-time">${messageTime}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        window.handleKeyPress = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        window.sendMessage = async function() {
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            
            if (!content || !currentConversation) return;

            try {
                await addDoc(collection(db, 'messages'), {
                    from: currentUser.uid,
                    fromName: currentUser.displayName || 'Anonymous',
                    fromPhoto: currentUser.photoURL || '',
                    to: currentConversation.id,
                    toName: currentConversation.name,
                    content: content,
                    timestamp: new Date().toISOString(),
                    read: false
                });

                messageInput.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createFloatingHearts();
            loadConversations();
        });

        // Background music handler
        document.addEventListener('DOMContentLoaded', function() {
            const music = document.getElementById('backgroundMusic');
            
            function playMusic() {
                if (music) {
                    music.volume = 0.3;
                    music.play().then(() => {
                        console.log('Background music started playing');
                    }).catch(error => {
                        console.log('Could not autoplay audio:', error);
                        document.addEventListener('click', function playOnClick() {
                            music.play().then(() => {
                                console.log('Background music started after user click');
                                document.removeEventListener('click', playOnClick);
                            }).catch(err => console.log('Still could not play audio:', err));
                        }, { once: true });
                    });
                }
            }
            
            playMusic();
        });
    </script>
</body>
</html>